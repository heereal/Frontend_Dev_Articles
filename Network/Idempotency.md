# 멱등성
> [멱등성이 뭔가요?](https://velog.io/@tosspayments/%EB%A9%B1%EB%93%B1%EC%84%B1%EC%9D%B4-%EB%AD%94%EA%B0%80%EC%9A%94)

<br/>

## 멱등(Idempotent)하다는 것
- 컴퓨터 과학에서 멱등하다는 것은 **첫 번째 수행을 한 뒤 여러 차례 적용해도 결과를 변경시키지 않는 작업** 또는 기능의 속성을 뜻한다. 즉, 멱등한 작업의 결과는 한 번 수행하든 여러 번 수행하든 같다.
- 예를 들어, 어떤 숫자에 1을 곱하는 연산은 여러 번 수행해도 처음 1을 곱한 것과 같은 숫자가 되기 때문에 멱등하다.

<br/>

## HTTP 메서드의 멱등성
| 메서드 | 멱등성 |
| --- | --- |
| CONNECT | X |
| DELETE | O |
| GET | O |
| HEAD | O |
| OPTIONS | O |
| POST | X |
| PUT | O |
| PATCH | X |
| TRACE | O |
- GET, PUT처럼 리소스를 조회하거나 대체하는 메서드는 멱등하다. PUT도 여러 번 호출해도 매번 같은 리소스로 업데이트되기 때문에 결과가 달라지지 않는다. DELETE 역시 여러 번 호출해도 삭제된 리소스에 대한 결과는 달라지지 않는다.
- 반면 서버 데이터를 변경하는 POST, PATCH는 호출할 때마다 응답이 달라지기 때문에 멱등한 메서드가 아니다. 이렇게 멱등하지 않은 메서드에 멱등성을 제공하려면 서버에서 멱등성을 구현해야 한다.

<br/>

## API 관점에서 멱등성 바라보기
- 멱등한 API라면 두 번 이상 요청해도 결과는 처음 요청과 똑같이 돌아온다. 단순히 돌아온 값이 같을 뿐 아니라 서버 상태(DB)에도 영향을 미치지 않는다.
- 이렇게 시스템에 의도하지 않은 문제를 일으키지 않고 요청을 재시도할 수 있기 때문에, 멱등성은 결함 없고 안전한 API를 만드는데 중요하다.
- 멱등성을 보장하기 위해 **멱등키를 API 요청에 포함**한다. 이전 요청과 동일한 멱등키를 가진 요청을 받으면 서버에서 이 요청을 중복으로 판단한 뒤 실제로 처리하지 않고 첫 요청과 같은 응답을 반환하는 방식이다.

<br/>

## 멱등한 요청인지 알 수 있는 방법
1. API 서버는 취소 요청마다 헤더에 멱등키가 있는지 확인한다.
2. 멱등키를 저장하기 위해 DB를 만든다. 멱등키가 포함된 취소 요청이 들어왔을 때 이 DB를 쿼리 해서 요청이 들어온 멱등키와 매칭되는 요청 기록이 있는지 확인한다.   
3. 만약 이전에 같은 멱등키로 들어온 요청이 있다면, 서버에서 실제 요청을 실행하지 않고 저장되어 있던 응답 데이터를 돌려준다.   
4. 만약 멱등키와 매칭되는 이전 기록이 없다면, 새로 생성된 응답을 저장하는 새로운 기록을 만들고 응답을 클라이언트에 돌려준다.

